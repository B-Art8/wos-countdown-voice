<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Discord Bot Control</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .tab { cursor: pointer; }
        .tab.active { font-weight: bold; }
        .guild-tabs, .log-tabs { margin-top: 20px; }
        .channels, .controls, .logs { margin-top: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="my-4 text-center">Discord Bot Control</h1>
        
        <!-- Buttons to switch between Servers and Logs -->
        <div class="btn-group mb-3" role="group">
            <button id="showServers" class="btn btn-primary" onclick="showSection('servers')">Servers</button>
            <button id="showLogs" class="btn btn-secondary" onclick="showSection('logs')">Logs</button>
        </div>
        
        <!-- Servers view -->
        <div id="serversSection" class="section">
            <!-- Guild tabs -->
            <div id="guilds" class="nav nav-tabs guild-tabs">
                <!-- Guild tabs will be loaded here dynamically -->
            </div>
            
            <!-- Channels list with join buttons -->
            <div id="channels" class="channels">
                <div class="alert alert-info">Select a guild to see its channels</div>
            </div>
            
            <!-- Always-visible Controls for sound and disconnecting -->
            <div id="controls" class="controls">
                <!-- Sound buttons and Leave button will be rendered here at page load -->
            </div>
        </div>

        <!-- Logs view -->
        <div id="logsSection" class="section hidden">
            <!-- Log category tabs -->
            <div id="logCategories" class="nav nav-tabs log-tabs">
                <!-- Log category tabs will be loaded here dynamically -->
            </div>

            <!-- Log messages display -->
            <div id="logs" class="logs">
                <div class="alert alert-info">Select a category to view logs.</div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let selectedGuildId = null;
        let selectedChannelId = null;
        let activeCategory = 'all';
        let lastLogId = 0;  // Store the last received log ID
        let allLogs = [];  // Store all logs to display and filter

        function showSection(section) {
            document.getElementById('serversSection').classList.add('hidden');
            document.getElementById('logsSection').classList.add('hidden');
            document.getElementById('showServers').classList.remove('btn-primary');
            document.getElementById('showLogs').classList.remove('btn-primary');
            document.getElementById('showServers').classList.add('btn-secondary');
            document.getElementById('showLogs').classList.add('btn-secondary');

            if (section === 'servers') {
                document.getElementById('serversSection').classList.remove('hidden');
                document.getElementById('showServers').classList.add('btn-primary');
            } else if (section === 'logs') {
                document.getElementById('logsSection').classList.remove('hidden');
                document.getElementById('showLogs').classList.add('btn-primary');
            }
        }

        async function loadGuilds() {
            const response = await fetch('/api/guilds');
            const guilds = await response.json();
            const guildsContainer = document.getElementById('guilds');
            guildsContainer.innerHTML = '';

            guilds.forEach(guild => {
                const guildTab = document.createElement('a');
                guildTab.className = 'nav-item nav-link tab';
                guildTab.innerText = guild.name;
                guildTab.onclick = () => {
                    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                    guildTab.classList.add('active');
                    selectedGuildId = guild.id;
                    loadChannels(guild.id);
                };
                guildsContainer.appendChild(guildTab);
            });
        }

        async function loadChannels(guildId) {
            const response = await fetch(`/api/channels/${guildId}`);
            const channels = await response.json();
            const channelsContainer = document.getElementById('channels');
            channelsContainer.innerHTML = '';

            if (channels.error) {
                channelsContainer.innerHTML = `<div class="alert alert-danger">${channels.error}</div>`;
            } else {
                const listGroup = document.createElement('div');
                listGroup.className = 'list-group';
                
                channels.forEach(channel => {
                    const channelItem = document.createElement('a');
                    channelItem.className = 'list-group-item list-group-item-action';
                    channelItem.innerText = channel.name;
                    
                    const joinButton = document.createElement('button');
                    joinButton.className = 'btn btn-primary ml-2';
                    joinButton.innerText = 'Join';
                    joinButton.onclick = () => {
                        selectedChannelId = channel.id;
                        joinChannel(guildId, channel.id);
                    };

                    channelItem.appendChild(joinButton);
                    listGroup.appendChild(channelItem);
                });

                channelsContainer.appendChild(listGroup);
            }
        }

        async function displayControls() {
            const controlsContainer = document.getElementById('controls');
            controlsContainer.innerHTML = '';

            const response = await fetch('/api/sounds');
            const sounds = await response.json();

            const playHeader = document.createElement('h3');
            playHeader.innerText = 'Available Sounds';
            controlsContainer.appendChild(playHeader);

            sounds.forEach(sound => {
                const playButton = document.createElement('button');
                playButton.className = 'btn btn-secondary m-2';
                playButton.innerText = `Play ${sound}`;
                playButton.onclick = () => playSound(selectedGuildId, selectedChannelId, sound);
                controlsContainer.appendChild(playButton);
            });

            const leaveButton = document.createElement('button');
            leaveButton.className = 'btn btn-danger m-2';
            leaveButton.innerText = 'Leave Channel';
            leaveButton.onclick = () => leaveChannel(selectedGuildId, selectedChannelId);
            controlsContainer.appendChild(leaveButton);
        }

        async function loadLogCategories() {
            const response = await fetch('/api/logs/categories');
            const categories = await response.json();
            const logCategoriesContainer = document.getElementById('logCategories');
            logCategoriesContainer.innerHTML = '';

            const allTab = document.createElement('a');
            allTab.className = 'nav-item nav-link tab active';
            allTab.innerText = 'All';
            allTab.onclick = () => {
                setActiveCategory('all');
            };
            logCategoriesContainer.appendChild(allTab);

            categories.forEach(category => {
                const categoryTab = document.createElement('a');
                categoryTab.className = 'nav-item nav-link tab';
                categoryTab.innerText = category;
                categoryTab.onclick = () => {
                    setActiveCategory(category);
                };
                logCategoriesContainer.appendChild(categoryTab);
            });
        }

        function setActiveCategory(category) {
            activeCategory = category;
            document.querySelectorAll('.log-tabs .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.log-tabs .tab:contains(${category === 'all' ? 'All' : category})`).classList.add('active');
            displayLogs();
        }

        // Fetch new logs from the server, starting from the last log ID
        async function fetchNewLogs() {
            const response = await fetch(`/api/logs?last_log_id=${lastLogId}`);
            const logs = await response.json();
            
            // Update the last log ID with the highest ID from the new logs
            const logIds = Object.keys(logs).map(Number);
            if (logIds.length > 0) {
                lastLogId = Math.max(...logIds);
            }

            // Append the new logs to the allLogs array
            Object.values(logs).forEach(log => {
                allLogs.push(log);
            });

            displayLogs(); // Refresh displayed logs
        }

        // Display logs based on the active category
        function displayLogs() {
            const logsContainer = document.getElementById('logs');
            logsContainer.innerHTML = '';

            const filteredLogs = allLogs.filter(log => {
                return activeCategory === 'all' || log.category === activeCategory;
            });

            logsContainer.innerHTML = filteredLogs.map(log => {
                return `<div class="alert alert-${getLogSeverity(log.severity)}">${log.timestamp} - ${log.message}</div>`;
            }).join('');
        }

        function getLogSeverity(severity) {
            switch (severity.toLowerCase()) {
                case 'debug': return 'secondary';
                case 'info': return 'primary';
                case 'warning': return 'warning';
                case 'error': return 'danger';
                case 'critical': return 'dark';
                default: return 'light';
            }
        }

        // Fetch new logs every second
        setInterval(fetchNewLogs, 1000);

        // Initialize on page load
        loadGuilds();
        displayControls();
        loadLogCategories();
        showSection('servers');
    </script>
</body>
</html>
